import{b as Ve}from"/build/_shared/chunk-2WXH3QX5.js";import{c as lt,e as ft}from"/build/_shared/chunk-ADMCF34Z.js";var Ne=lt((dn,Ue)=>{"use strict";Ue.exports=function t(e,n){if(e===n)return!0;if(e&&n&&typeof e=="object"&&typeof n=="object"){if(e.constructor!==n.constructor)return!1;var r,i,a;if(Array.isArray(e)){if(r=e.length,r!=n.length)return!1;for(i=r;i--!==0;)if(!t(e[i],n[i]))return!1;return!0}if(e.constructor===RegExp)return e.source===n.source&&e.flags===n.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===n.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===n.toString();if(a=Object.keys(e),r=a.length,r!==Object.keys(n).length)return!1;for(i=r;i--!==0;)if(!Object.prototype.hasOwnProperty.call(n,a[i]))return!1;for(i=r;i--!==0;){var o=a[i];if(!t(e[o],n[o]))return!1}return!0}return e!==e&&n!==n}});function ge(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];let i=t.length-1;return t.slice(0,i).reduce((a,o,c)=>a+o+n[c],"")+t[i]}var at=ft(Ne(),1);function qe(t,e,n){var r=n||{},i=r.noTrailing,a=i===void 0?!1:i,o=r.noLeading,c=o===void 0?!1:o,f=r.debounceMode,s=f===void 0?void 0:f,d,u=!1,p=0;function w(){d&&clearTimeout(d)}function m(E){var P=E||{},C=P.upcomingOnly,L=C===void 0?!1:C;w(),u=!L}function k(){for(var E=arguments.length,P=new Array(E),C=0;C<E;C++)P[C]=arguments[C];var L=this,z=Date.now()-p;if(u)return;function X(){p=Date.now(),e.apply(L,P)}function ee(){d=void 0}!c&&s&&!d&&X(),w(),s===void 0&&z>t?c?(p=Date.now(),a||(d=setTimeout(s?ee:X,t))):X():a!==!0&&(d=setTimeout(s?ee:X,s===void 0?t-z:t))}return k.cancel=m,k}function dt(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function pt(t){let e=[];for(let n of t.split("."))n==="*"?e.push("[^.]+"):n==="**"?e.push(".*"):e.push(dt(n));return new RegExp("^".concat(e.join("."),"$"))}var he=class{constructor(e){this.pattern=e,this.patternRe=pt(e)}matches(e){return this.patternRe.test(e)}toJSON(){return this.pattern}},U=class{constructor(e){this.type="stream",this.generator=e,this.ticker=null,this.isDone=!1,this.data=[]}isArray(){return!0}async get(){let e=[];for await(let n of this)e.push(await n.get());return e}async*[Symbol.asyncIterator](){let e=0;for(;;){for(;e<this.data.length;e++)yield this.data[e];if(this.isDone)return;await this._nextTick()}}_nextTick(){if(this.ticker)return this.ticker;let e,n=()=>{this.ticker=new Promise(a=>{e=a})},r=()=>{e(),n()},i=async()=>{for await(let a of this.generator())this.data.push(a),r();this.isDone=!0,r()};return n(),i(),this.ticker}},yt=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?(Z|([-+]\d{2}:\d{2}))$/;function ht(t){return yt.test(t)?new Date(t):null}function mt(t){let e=B(t.getUTCFullYear(),4),n=B(t.getUTCMonth()+1,2),r=B(t.getUTCDate(),2),i=B(t.getUTCHours(),2),a=B(t.getUTCMinutes(),2),o=B(t.getUTCSeconds(),2),c="",f=t.getMilliseconds();return f!=0&&(c=".".concat(B(f,3))),"".concat(e,"-").concat(n,"-").concat(r,"T").concat(i,":").concat(a,":").concat(o).concat(c,"Z")}function B(t,e){let n=t.toString();for(;n.length<e;)n="0".concat(n);return n}var M=class{constructor(e,n){this.data=e,this.type=n}isArray(){return this.type==="array"}async get(){return this.data}[Symbol.asyncIterator](){if(Array.isArray(this.data))return function*(e){for(let n of e)yield _(n)}(this.data);throw new Error("Cannot iterate over: ".concat(this.type))}},l=new M(null,"null"),A=new M(!0,"boolean"),x=new M(!1,"boolean"),W=class{constructor(e){this.date=e}static parseToValue(e){let n=ht(e);return n?new M(new W(n),"datetime"):l}equals(e){return this.date.getTime()==e.date.getTime()}add(e){let n=new Date(this.date.getTime());return n.setTime(n.getTime()+e*1e3),new W(n)}difference(e){return(this.date.getTime()-e.date.getTime())/1e3}compareTo(e){return this.date.getTime()-e.date.getTime()}toString(){return mt(this.date)}toJSON(){return this.toString()}};function R(t){return Number.isFinite(t)?new M(t,"number"):l}function I(t){return new M(t,"string")}function Be(t){return new M(t,"datetime")}function wt(t){return new M(t,"path")}function bt(t){return t&&typeof t.next=="function"}function _(t){return bt(t)?new U(async function*(){for await(let e of t)yield _(e)}):t==null?l:new M(t,Z(t))}function Z(t){return t===null||typeof t>"u"?"null":Array.isArray(t)?"array":t instanceof he?"path":t instanceof W?"datetime":typeof t}function ve(t,e){return t.type==="string"&&e.type==="string"||t.type==="boolean"&&e.type==="boolean"||t.type==="null"&&e.type==="null"||t.type==="number"&&e.type==="number"?t.data===e.data:t.type==="datetime"&&e.type==="datetime"?t.data.equals(e.data):!1}var gt=/([^!@#$%^&*(),\\/?";:{}|[\]+<>\s-])+/g,vt=/([^!@#$%^&(),\\/?";:{}|[\]+<>\s-])+/g,Je=/(\b\.+|\.+\b)/g,kt=1024;function Et(t,e){return t.length===0||e.length===0?!1:e.every(n=>n(t))}function Qe(t){return t.replace(Je,"").match(gt)||[]}function _t(t){return Ze(t).map(n=>r=>r.some(i=>n.test(i)))}function Ze(t){return(t.replace(Je,"").match(vt)||[]).map(n=>new RegExp("^".concat(n.slice(0,kt).replace(/\*/g,".*"),"$"),"i"))}async function me(t,e){if(t.type==="string")return e(t.data),!0;if(t.isArray()){let n=!0;for await(let r of t)r.type==="string"?e(r.data):n=!1;return n}return!1}var Fe={datetime:1,number:2,string:3,boolean:4};function F(t,e){let n=Z(t),r=Z(e);if(n!==r)return null;switch(n){case"number":case"boolean":return t-e;case"string":return t<e?-1:t>e?1:0;case"datetime":return t.compareTo(e);default:return null}}function xt(t,e){let n=Z(t),r=Z(e),i=Fe[n]||100,a=Fe[r]||100;if(i!==a)return i-a;let o=F(t,e);return o===null&&(o=0),o}var St={"==":function(e,n){return ve(e,n)?A:x},"!=":function(e,n){return ve(e,n)?x:A},">":function(e,n){if(e.type==="stream"||n.type==="stream")return l;let r=F(e.data,n.data);return r===null?l:r>0?A:x},">=":function(e,n){if(e.type==="stream"||n.type==="stream")return l;let r=F(e.data,n.data);return r===null?l:r>=0?A:x},"<":function(e,n){if(e.type==="stream"||n.type==="stream")return l;let r=F(e.data,n.data);return r===null?l:r<0?A:x},"<=":function(e,n){if(e.type==="stream"||n.type==="stream")return l;let r=F(e.data,n.data);return r===null?l:r<=0?A:x},in:async function(e,n){if(n.type==="path")return e.type!=="string"?l:n.data.matches(e.data)?A:x;if(n.isArray()){for await(let r of n)if(ve(e,r))return A;return x}return l},match:async function(e,n){let r=[],i=[];return await me(e,c=>{r=r.concat(Qe(c))}),await me(n,c=>{i=i.concat(_t(c))})&&Et(r,i)?A:x},"+":function(e,n){return e.type==="datetime"&&n.type==="number"?Be(e.data.add(n.data)):e.type==="number"&&n.type==="number"?R(e.data+n.data):e.type==="string"&&n.type==="string"?I(e.data+n.data):e.type==="object"&&n.type==="object"?_({...e.data,...n.data}):e.type==="array"&&n.type==="array"?_(e.data.concat(n.data)):e.isArray()&&n.isArray()?new U(async function*(){for await(let r of e)yield r;for await(let r of n)yield r}):l},"-":function(e,n){return e.type==="datetime"&&n.type==="number"?Be(e.data.add(-n.data)):e.type==="datetime"&&n.type==="datetime"?R(e.data.difference(n.data)):e.type==="number"&&n.type==="number"?R(e.data-n.data):l},"*":re((t,e)=>t*e),"/":re((t,e)=>t/e),"%":re((t,e)=>t%e),"**":re((t,e)=>Math.pow(t,e))};function re(t){return function(e,n){if(e.type==="number"&&n.type==="number"){let r=t(e.data,n.data);return R(r)}return l}}var H=class{constructor(e,n,r,i,a){this.isHidden=!1,this.params=e,this.source=n,this.value=r,this.context=i,this.parent=a}createNested(e){return this.isHidden?new H(this.params,this.source,e,this.context,this.parent):new H(this.params,this.source,e,this.context,this)}createHidden(e){let n=this.createNested(e);return n.isHidden=!0,n}};function je(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:je,r=At[t.type];return r(t,e,n)}function $e(t,e){return"then"in t?t.then(e):e(t)}var At={This(t,e){return e.value},Selector(){throw new Error("Selectors can not be evaluated")},Everything(t,e){return e.source},Parameter(t,e){let{name:n}=t;return _(e.params[n])},Context(t,e){let{key:n}=t;if(n==="before"||n==="after")return e.context[n]||l;throw new Error("unknown context key: ".concat(n))},Parent(t,e){let{n}=t,r=e;for(let i=0;i<n;i++){if(!r.parent)return l;r=r.parent}return r.value},OpCall(t,e,n){let{op:r,left:i,right:a}=t,o=St[r];if(!o)throw new Error("Unknown operator: ".concat(r));let c=n(i,e),f=n(a,e);return"then"in c||"then"in f?(async()=>o(await c,await f))():o(c,f)},async Select(t,e,n){let{alternatives:r,fallback:i}=t;for(let a of r){let o=await n(a.condition,e);if(o.type==="boolean"&&o.data===!0)return n(a.value,e)}return i?n(i,e):l},async InRange(t,e,n){let{base:r,left:i,right:a,isInclusive:o}=t,c=await n(r,e),f=await n(i,e),s=await n(a,e),d=F(await c.get(),await f.get());if(d===null)return l;let u=F(await c.get(),await s.get());return u===null?l:o?d>=0&&u<=0?A:x:d>=0&&u<0?A:x},async Filter(t,e,n){let{base:r,expr:i}=t,a=await n(r,e);return a.isArray()?new U(async function*(){for await(let o of a){let c=e.createNested(o),f=await n(i,c);f.type==="boolean"&&f.data===!0&&(yield o)}}):l},async Projection(t,e,n){let{base:r,expr:i}=t,a=await n(r,e);if(a.type!=="object")return l;let o=e.createNested(a);return n(i,o)},FuncCall(t,e,n){let{func:r,args:i}=t;return r(i,e,n)},async PipeFuncCall(t,e,n){let{func:r,base:i,args:a}=t,o=await n(i,e);return r(o,a,e,n)},async AccessAttribute(t,e,n){let{base:r,name:i}=t,a=e.value;return r&&(a=await n(r,e)),a.type==="object"&&a.data.hasOwnProperty(i)?_(a.data[i]):l},async AccessElement(t,e,n){let{base:r,index:i}=t,a=await n(r,e);if(!a.isArray())return l;let o=await a.get(),c=i<0?i+o.length:i;return _(o[c])},async Slice(t,e,n){let{base:r,left:i,right:a,isInclusive:o}=t,c=await n(r,e);if(!c.isArray())return l;let f=await c.get(),s=i,d=a;return s<0&&(s=f.length+s),d<0&&(d=f.length+d),o&&d++,s<0&&(s=0),d<0&&(d=0),_(f.slice(s,d))},async Deref(t,e,n){let{base:r}=t,i=await n(r,e);if(!e.source.isArray()||i.type!=="object")return l;let a=i.data._ref;if(typeof a!="string")return l;for await(let o of e.source)if(o.type==="object"&&a===o.data._id)return o;return l},Value(t){let{value:e}=t;return _(e)},Group(t,e,n){let{base:r}=t;return n(r,e)},async Object(t,e,n){let{attributes:r}=t,i={};for(let a of r){let o=a.type;switch(a.type){case"ObjectAttributeValue":{let c=await n(a.value,e);i[a.name]=await c.get();break}case"ObjectConditionalSplat":{let c=await n(a.condition,e);if(c.type!=="boolean"||c.data===!1)continue;let f=await n(a.value,e);f.type==="object"&&Object.assign(i,f.data);break}case"ObjectSplat":{let c=await n(a.value,e);c.type==="object"&&Object.assign(i,c.data);break}default:throw new Error("Unknown node type: ".concat(o))}}return _(i)},Array(t,e,n){let{elements:r}=t;return new U(async function*(){for(let i of r){let a=await n(i.value,e);if(i.isSplat){if(a.isArray())for await(let o of a)yield o}else yield a}})},Tuple(){throw new Error("tuples can not be evaluated")},async Or(t,e,n){let{left:r,right:i}=t,a=await n(r,e),o=await n(i,e);return a.type==="boolean"&&a.data===!0||o.type==="boolean"&&o.data===!0?A:a.type!=="boolean"||o.type!=="boolean"?l:x},async And(t,e,n){let{left:r,right:i}=t,a=await n(r,e),o=await n(i,e);return a.type==="boolean"&&a.data===!1||o.type==="boolean"&&o.data===!1?x:a.type!=="boolean"||o.type!=="boolean"?l:A},async Not(t,e,n){let{base:r}=t,i=await n(r,e);return i.type!=="boolean"?l:i.data?x:A},Neg(t,e,n){let{base:r}=t;return $e(n(r,e),i=>i.type!=="number"?l:R(-i.data))},Pos(t,e,n){let{base:r}=t;return $e(n(r,e),i=>i.type!=="number"?l:R(i.data))},Asc(){return l},Desc(){return l},async ArrayCoerce(t,e,n){let{base:r}=t,i=await n(r,e);return i.isArray()?i:l},async Map(t,e,n){let{base:r,expr:i}=t,a=await n(r,e);return a.isArray()?new U(async function*(){for await(let o of a){let c=e.createHidden(o);yield await n(i,c)}}):l},async FlatMap(t,e,n){let{base:r,expr:i}=t,a=await n(r,e);return a.isArray()?new U(async function*(){for await(let o of a){let c=e.createHidden(o),f=await n(i,c);if(f.isArray())for await(let s of f)yield s;else yield f}}):l}};function Re(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=_(e.root),r=_(e.dataset),i={...e.params},a=new H(i,r,n,{timestamp:e.timestamp||new Date,identity:e.identity===void 0?"me":e.identity,sanity:e.sanity,after:e.after?_(e.after):null,before:e.before?_(e.before):null},null);return je(t,a)}function pe(t){switch(t.type){case"Group":case"Value":case"Parameter":return!0;case"Pos":case"Neg":return pe(t.base);case"OpCall":switch(t.op){case"+":case"-":case"*":case"/":case"%":case"**":return pe(t.left)&&pe(t.right);default:return!1}default:return!1}}var Ot=new H({},l,l,{timestamp:new Date(0),identity:"me",before:null,after:null},null);function ke(t){return pe(t)?Xe(t):null}function Xe(t){let e=je(t,Ot,Xe);if("then"in e)throw new Error("BUG: constant evaluate should never return a promise");return e}async function Tt(t){if(t.type==="object")return Ke(t.data);if(t.isArray()){let e=await Ye(t);if(e.length>0)return e.join(`

`)}return null}async function Ye(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];for await(let n of t)if(n.type==="object"){let r=Ke(n.data);r!==null&&e.push(r)}else n.isArray()&&await Ye(n,e);return e}function Ke(t){if(typeof t._type!="string")return null;let e=t.children;if(!Array.isArray(e))return null;let n="";for(let r of e)r&&typeof r=="object"&&typeof r._type=="string"&&r._type==="span"&&typeof r.text=="string"&&(n+=r.text);return n}var We=1.2;async function Q(t,e,n){if(t.type==="OpCall"&&t.op==="match")return Ct(t.left,t.right,e,n);if(t.type==="FuncCall"&&t.name==="boost"){let r=await Q(t.args[0],e,n),i=await n(t.args[1],e);return i.type==="number"&&r>0?r+i.data:0}switch(t.type){case"Or":{let r=await Q(t.left,e,n),i=await Q(t.right,e,n);return r+i}case"And":{let r=await Q(t.left,e,n),i=await Q(t.right,e,n);return r===0||i===0?0:r+i}default:{let r=await n(t,e);return r.type==="boolean"&&r.data===!0?1:0}}}async function Ct(t,e,n,r){let i=await r(t,n),a=await r(e,n),o=[],c=[];if(await me(i,d=>{o=o.concat(Qe(d))}),!await me(a,d=>{c=c.concat(Ze(d))})||o.length===0||c.length===0)return 0;let s=0;for(let d of c){let u=o.reduce((p,w)=>p+(d.test(w)?1:0),0);s+=u*(We+1)/(u+We)}return s}function xe(t,e){switch(Z(t)){case"array":for(let n of t)if(xe(n,e))return!0;break;case"object":if(t._ref)return e.has(t._ref);for(let n of Object.values(t))if(xe(n,e))return!0;break}return!1}function jt(t){let e=0;for(let n=0;n<t.length;n++){let r=t.charCodeAt(n);r>=55296&&r<=56319||e++}return e}var v={};v.anywhere=async function(){throw new Error("not implemented")};v.anywhere.arity=1;v.coalesce=async function(e,n,r){for(let i of e){let a=await r(i,n);if(a.type!=="null")return a}return l};v.count=async function(e,n,r){let i=await r(e[0],n);if(!i.isArray())return l;let a=0;for await(let o of i)a++;return R(a)};v.count.arity=1;v.dateTime=async function(e,n,r){let i=await r(e[0],n);return i.type==="datetime"?i:i.type!=="string"?l:W.parseToValue(i.data)};v.dateTime.arity=1;v.defined=async function(e,n,r){return(await r(e[0],n)).type==="null"?x:A};v.defined.arity=1;v.identity=async function(e,n){return I(n.context.identity)};v.identity.arity=0;v.length=async function(e,n,r){let i=await r(e[0],n);if(i.type==="string")return R(jt(i.data));if(i.isArray()){let a=0;for await(let o of i)a++;return R(a)}return l};v.length.arity=1;v.path=async function(e,n,r){let i=await r(e[0],n);return i.type!=="string"?l:wt(new he(i.data))};v.path.arity=1;v.string=async function(e,n,r){let i=await r(e[0],n);switch(i.type){case"number":case"string":case"boolean":case"datetime":return I("".concat(i.data));default:return l}};v.string.arity=1;v.references=async function(e,n,r){let i=new Set;for(let o of e){let c=await r(o,n);if(c.type==="string")i.add(c.data);else if(c.isArray())for await(let f of c)f.type==="string"&&i.add(f.data)}if(i.size===0)return x;let a=await n.value.get();return xe(a,i)?A:x};v.references.arity=t=>t>=1;v.round=async function(e,n,r){let i=await r(e[0],n);if(i.type!=="number")return l;let a=i.data,o=0;if(e.length===2){let c=await r(e[1],n);if(c.type!=="number"||c.data<0||!Number.isInteger(c.data))return l;o=c.data}return o===0?a<0?R(-Math.round(-a)):R(Math.round(a)):R(Number(a.toFixed(o)))};v.round.arity=t=>t>=1&&t<=2;v.now=async function(e,n){return I(n.context.timestamp.toISOString())};v.now.arity=0;v.boost=async function(){throw new Error("unexpected boost call")};v.boost.arity=2;var D={};D.lower=async function(t,e,n){let r=await n(t[0],e);return r.type!=="string"?l:I(r.data.toLowerCase())};D.lower.arity=1;D.upper=async function(t,e,n){let r=await n(t[0],e);return r.type!=="string"?l:I(r.data.toUpperCase())};D.upper.arity=1;D.split=async function(t,e,n){let r=await n(t[0],e);if(r.type!=="string")return l;let i=await n(t[1],e);return i.type!=="string"?l:r.data.length===0?_([]):i.data.length===0?_(Array.from(r.data)):_(r.data.split(i.data))};D.split.arity=2;v.lower=D.lower;v.upper=D.upper;D.startsWith=async function(t,e,n){let r=await n(t[0],e);if(r.type!=="string")return l;let i=await n(t[1],e);return i.type!=="string"?l:r.data.startsWith(i.data)?A:x};D.startsWith.arity=2;var G={};G.join=async function(t,e,n){let r=await n(t[0],e);if(!r.isArray())return l;let i=await n(t[1],e);if(i.type!=="string")return l;let a="",o=!1;for await(let c of r){switch(o&&(a+=i.data),c.type){case"number":case"string":case"boolean":case"datetime":a+="".concat(c.data);break;default:return l}o=!0}return _(a)};G.join.arity=2;G.compact=async function(t,e,n){let r=await n(t[0],e);return r.isArray()?new U(async function*(){for await(let i of r)i.type!=="null"&&(yield i)}):l};G.compact.arity=1;G.unique=async function(t,e,n){let r=await n(t[0],e);return r.isArray()?new U(async function*(){let i=new Set;for await(let a of r)switch(a.type){case"number":case"string":case"boolean":case"datetime":i.has(a.data)||(i.add(a.data),yield a);break;default:yield a}}):l};G.unique.arity=1;var Ie={};Ie.text=async function(t,e,n){let r=await n(t[0],e),i=await Tt(r);return i===null?l:I(i)};Ie.text.arity=1;var Pe={};Pe.projectId=async function(t,e){return e.context.sanity?I(e.context.sanity.projectId):l};Pe.dataset=async function(t,e){return e.context.sanity?I(e.context.sanity.dataset):l};var Y={};Y.order=async function(e,n,r,i){if(await!0,!e.isArray())return l;let a=[],o=[],c=0;for(let d of n){let u="asc";d.type==="Desc"?(u="desc",d=d.base):d.type==="Asc"&&(d=d.base),a.push(d),o.push(u),c++}let f=[],s=0;for await(let d of e){let u=r.createNested(d),p=[await d.get(),s];for(let w=0;w<c;w++){let m=await i(a[w],u);p.push(await m.get())}f.push(p),s++}return f.sort((d,u)=>{for(let p=0;p<c;p++){let w=xt(d[p+2],u[p+2]);if(o[p]==="desc"&&(w=-w),w!==0)return w}return d[1]-u[1]}),_(f.map(d=>d[0]))};Y.order.arity=t=>t>=1;Y.score=async function(e,n,r,i){if(!e.isArray())return l;let a=[],o=[];for await(let c of e){if(c.type!=="object"){a.push(await c.get());continue}let f=r.createNested(c),s=typeof c.data._score=="number"?c.data._score:0;for(let u of n)s+=await Q(u,f,i);let d=Object.assign({},c.data,{_score:s});o.push(d)}return o.sort((c,f)=>f._score-c._score),_(o)};Y.score.arity=t=>t>=1;var q={};q.operation=async function(t,e){let n=e.context.before!==null,r=e.context.after!==null;return n&&r?I("update"):r?I("create"):n?I("delete"):l};q.changedAny=()=>{throw new Error("not implemented")};q.changedAny.arity=1;q.changedAny.mode="delta";q.changedOnly=()=>{throw new Error("not implemented")};q.changedOnly.arity=1;q.changedOnly.mode="delta";var K={};K.changedAny=()=>{throw new Error("not implemented")};K.changedAny.arity=3;K.changedOnly=()=>{throw new Error("not implemented")};K.changedOnly.arity=3;var N={};N.min=async function(t,e,n){let r=await n(t[0],e);if(!r.isArray())return l;let i;for await(let a of r)if(a.type!=="null"){if(a.type!=="number")return l;(i===void 0||a.data<i)&&(i=a.data)}return _(i)};N.min.arity=1;N.max=async function(t,e,n){let r=await n(t[0],e);if(!r.isArray())return l;let i;for await(let a of r)if(a.type!=="null"){if(a.type!=="number")return l;(i===void 0||a.data>i)&&(i=a.data)}return _(i)};N.max.arity=1;N.sum=async function(t,e,n){let r=await n(t[0],e);if(!r.isArray())return l;let i=0;for await(let a of r)if(a.type!=="null"){if(a.type!=="number")return l;i+=a.data}return _(i)};N.sum.arity=1;N.avg=async function(t,e,n){let r=await n(t[0],e);if(!r.isArray())return l;let i=0,a=0;for await(let o of r)if(o.type!=="null"){if(o.type!=="number")return l;i+=o.data,a++}return a===0?l:_(i/a)};N.avg.arity=1;var Rt={global:v,string:D,array:G,pt:Ie,delta:q,diff:K,sanity:Pe,math:N},Se=class{constructor(e,n,r){this.allowBoost=!1,this.string=e,this.marks=n,this.index=0,this.parseOptions=r}hasMark(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return this.index+e<this.marks.length}getMark(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return this.marks[this.index+e]}shift(){this.index+=1}process(e){let n=this.marks[this.index];this.shift();let r=e[n.name];if(!r)throw new Error("Unknown handler: ".concat(n.name));return r.call(e,this,n)}processString(){return this.shift(),this.processStringEnd()}processStringEnd(){let e=this.marks[this.index-1],n=this.marks[this.index];return this.shift(),this.string.slice(e.position,n.position)}slice(e){let n=this.marks[this.index].position;return this.string.slice(n,n+e)}},It=/^([\t\n\v\f\r \u0085\u00A0]|(\/\/[^\n]*\n))+/,Ee=/^\d+/,$=/^[a-zA-Z_][a-zA-Z_0-9]*/,ae=1,ie=2,oe=3,S=4,J=4,se=6,ce=6,ue=7,le=7,fe=7,de=8,Pt=10,Mt=10,Dt=8;function Lt(t){let e=0;e=y(t,e);let n=g(t,e,0);return n.type==="error"?n:(e=y(t,n.position),e!==t.length?(n.failPosition&&(e=n.failPosition-1),{type:"error",position:e}):(delete n.position,delete n.failPosition,n))}function g(t,e,n){let r=e,i=t[e],a;switch(i){case"+":{let s=g(t,y(t,e+1),Pt);if(s.type==="error")return s;a=[{name:"pos",position:r}].concat(s.marks),e=s.position;break}case"-":{let s=g(t,y(t,e+1),Dt);if(s.type==="error")return s;a=[{name:"neg",position:r}].concat(s.marks),e=s.position;break}case"(":{let s=g(t,y(t,e+1),0);if(s.type==="error")return s;switch(e=y(t,s.position),t[e]){case",":{for(a=[{name:"tuple",position:r}].concat(s.marks),e=y(t,e+1);;){if(s=g(t,e,0),s.type==="error")return s;if(e=y(t,s.position),t[e]!==",")break;e=y(t,e+1)}if(t[e]!==")")return{type:"error",position:e};e++,a.push({name:"tuple_end",position:e});break}case")":{e++,a=[{name:"group",position:r}].concat(s.marks);break}default:return{type:"error",position:e}}break}case"!":{let s=g(t,y(t,e+1),Mt);if(s.type==="error")return s;a=[{name:"not",position:r}].concat(s.marks),e=s.position;break}case"{":{let s=Ae(t,e);if(s.type==="error")return s;a=s.marks,e=s.position;break}case"[":if(a=[{name:"array",position:e}],e=y(t,e+1),t[e]!=="]")for(;;){t.slice(e,e+3)==="..."&&(a.push({name:"array_splat",position:e}),e=y(t,e+3));let s=g(t,e,0);if(s.type==="error")return s;if(a=a.concat(s.marks),e=s.position,e=y(t,e),t[e]!==","||(e=y(t,e+1),t[e]==="]"))break}if(t[e]==="]")e++,a.push({name:"array_end",position:e});else return{type:"error",position:e};break;case"'":case'"':{let s=Vt(t,e);if(s.type==="error")return s;a=s.marks,e=s.position;break}case"^":{for(e++,a=[];t[e]==="."&&t[e+1]==="^";)a.push({name:"dblparent",position:r}),e+=2;a.push({name:"parent",position:r});break}case"@":a=[{name:"this",position:r}],e++;break;case"*":a=[{name:"everything",position:r}],e++;break;case"$":{let s=V(t,e+1,$);s&&(e+=1+s,a=[{name:"param",position:r},{name:"ident",position:r+1},{name:"ident_end",position:e}]);break}default:{let s=V(t,e,Ee);if(s){e+=s;let u="integer";if(t[e]==="."){let p=V(t,e+1,Ee);p&&(u="float",e+=1+p)}if(t[e]==="e"||t[e]==="E"){u="sci",e++,(t[e]==="+"||t[e]==="-")&&e++;let p=V(t,e,Ee);if(!p)return{type:"error",position:e};e+=p}a=[{name:u,position:r},{name:u+"_end",position:e}];break}let d=V(t,e,$);if(d){switch(e+=d,t[e]){case":":case"(":{let u=Ge(t,r,e);if(u.type==="error")return u;a=u.marks,e=u.position;break}default:a=[{name:"this_attr",position:r},{name:"ident",position:r},{name:"ident_end",position:e}]}break}}}if(!a)return{type:"error",position:e};let o=12,c;e:for(;;){let s=y(t,e);if(s===t.length){e=s;break}if(c=He(t,s),c.type==="success"){for(a.unshift({name:"traverse",position:r});c.type==="success";)a=a.concat(c.marks),e=c.position,c=He(t,y(t,e));a.push({name:"traversal_end",position:e});continue}switch(t[s]){case"=":{switch(t[s+1]){case">":{if(n>ae||o<=ae)break e;let p=g(t,y(t,s+2),ae);if(p.type==="error")return p;a=a.concat(p.marks),a.unshift({name:"pair",position:r}),e=p.position,o=ae;break}case"=":{if(n>S||o<=S)break e;let p=g(t,y(t,s+2),5);if(p.type==="error")return p;a.unshift({name:"comp",position:r}),a.push({name:"op",position:s},{name:"op_end",position:s+2}),a=a.concat(p.marks),e=p.position,o=S;break}default:break e}break}case"+":{if(n>se||o<se)break e;let u=g(t,y(t,s+1),se+1);if(u.type==="error")return u;a=a.concat(u.marks),a.unshift({name:"add",position:r}),e=u.position,o=se;break}case"-":{if(n>ce||o<ce)break e;let u=g(t,y(t,s+1),ce+1);if(u.type==="error")return u;a=a.concat(u.marks),a.unshift({name:"sub",position:r}),e=u.position,o=ce;break}case"*":{if(t[s+1]==="*"){if(n>de||o<=de)break e;let p=g(t,y(t,s+2),de);if(p.type==="error")return p;a=a.concat(p.marks),a.unshift({name:"pow",position:r}),e=p.position,o=de;break}if(n>ue||o<ue)break e;let u=g(t,y(t,s+1),ue+1);if(u.type==="error")return u;a=a.concat(u.marks),a.unshift({name:"mul",position:r}),e=u.position,o=ue;break}case"/":{if(n>le||o<le)break e;let u=g(t,y(t,s+1),le+1);if(u.type==="error")return u;a=a.concat(u.marks),a.unshift({name:"div",position:r}),e=u.position,o=le;break}case"%":{if(n>fe||o<fe)break e;let u=g(t,y(t,s+1),fe+1);if(u.type==="error")return u;a=a.concat(u.marks),a.unshift({name:"mod",position:r}),e=u.position,o=fe;break}case"<":case">":{if(n>S||o<=S)break e;let u=s+1;t[u]==="="&&u++;let p=g(t,y(t,u),S+1);if(p.type==="error")return p;a.unshift({name:"comp",position:r}),a.push({name:"op",position:s},{name:"op_end",position:u}),a=a.concat(p.marks),e=p.position,o=S;break}case"|":{if(t[s+1]==="|"){if(n>ie||o<ie)break e;let u=g(t,y(t,s+2),ie+1);if(u.type==="error")return u;a=a.concat(u.marks),a.unshift({name:"or",position:r}),e=u.position,o=ie}else{if(n>11||o<11)break e;let u=y(t,s+1),p=V(t,u,$);if(!p)return{type:"error",position:u};if(e=u+p,t[e]==="("||t[e]===":"){let w=Ge(t,u,e);if(w.type==="error")return w;a=a.concat(w.marks),a.unshift({name:"pipecall",position:r}),e=w.position,o=11}}break}case"&":{if(t[s+1]!="&"||n>oe||o<oe)break e;let u=g(t,y(t,s+2),oe+1);if(u.type==="error")return u;a=a.concat(u.marks),a.unshift({name:"and",position:r}),e=u.position,o=oe;break}case"!":{if(t[s+1]!=="="||n>S||o<S)break e;let u=g(t,y(t,s+2),S+1);if(u.type==="error")return u;a.unshift({name:"comp",position:r}),a.push({name:"op",position:s},{name:"op_end",position:s+2}),a=a.concat(u.marks),e=u.position,o=S;break}case"d":{if(t.slice(s,s+4)!=="desc"||n>J||o<J)break e;a.unshift({name:"desc",position:r}),e=s+4,o=J;break}case"a":{if(t.slice(s,s+3)!=="asc"||n>J||o<J)break e;a.unshift({name:"asc",position:r}),e=s+3,o=J;break}default:switch(Ut(t,s,$)){case"in":{if(n>S||o<=S)break e;e=y(t,s+2);let p=!1;t[e]==="("&&(p=!0,e=y(t,e+1));let w=e,m=g(t,e,S+1);if(m.type==="error")return m;if(e=y(t,m.position),t[e]==="."&&t[e+1]==="."){let k="inc_range";t[e+2]==="."?(k="exc_range",e=y(t,e+3)):e=y(t,e+2);let E=g(t,e,S+1);if(E.type==="error")return E;a.unshift({name:"in_range",position:r}),a=a.concat({name:k,position:w},m.marks,E.marks),e=E.position}else a.unshift({name:"comp",position:r}),a.push({name:"op",position:s},{name:"op_end",position:s+2}),a=a.concat(m.marks);if(p){if(e=y(t,e),t[e]!==")")return{type:"error",position:e};e++}o=S;break}case"match":{if(n>S||o<=S)break e;let p=g(t,y(t,s+5),S+1);if(p.type==="error")return p;a.unshift({name:"comp",position:r}),a.push({name:"op",position:s},{name:"op_end",position:s+5}),a=a.concat(p.marks),e=p.position,o=4;break}default:break e}}}let f=c?.type==="error"&&c.position;return{type:"success",marks:a,position:e,failPosition:f}}function He(t,e){let n=e;switch(t[e]){case".":{e=y(t,e+1);let o=e,c=V(t,e,$);return c?(e+=c,{type:"success",marks:[{name:"attr_access",position:n},{name:"ident",position:o},{name:"ident_end",position:e}],position:e}):{type:"error",position:e}}case"-":if(t[e+1]!==">")return{type:"error",position:e};let r=[{name:"deref",position:n}];e+=2;let i=y(t,e),a=V(t,i,$);return a&&(e=i+a,r.push({name:"deref_attr",position:i},{name:"ident",position:i},{name:"ident_end",position:e})),{type:"success",marks:r,position:e};case"[":{if(e=y(t,e+1),t[e]==="]")return{type:"success",marks:[{name:"array_postfix",position:n}],position:e+1};let o=e,c=g(t,e,0);if(c.type==="error")return c;if(e=y(t,c.position),t[e]==="."&&t[e+1]==="."){let f="inc_range";t[e+2]==="."?(f="exc_range",e+=3):e+=2,e=y(t,e);let s=g(t,e,0);return s.type==="error"?s:(e=y(t,s.position),t[e]!=="]"?{type:"error",position:e}:{type:"success",marks:[{name:"slice",position:n},{name:f,position:o}].concat(c.marks,s.marks),position:e+1})}return t[e]!=="]"?{type:"error",position:e}:{type:"success",marks:[{name:"square_bracket",position:n}].concat(c.marks),position:e+1}}case"|":{if(e=y(t,e+1),t[e]==="{"){let o=Ae(t,e);return o.type==="error"||o.marks.unshift({name:"projection",position:n}),o}break}case"{":{let o=Ae(t,e);return o.type==="error"||o.marks.unshift({name:"projection",position:n}),o}}return{type:"error",position:e}}function Ge(t,e,n){let r=[];if(r.push({name:"func_call",position:e}),t[n]===":"&&t[n+1]===":"){r.push({name:"namespace",position:e}),r.push({name:"ident",position:e},{name:"ident_end",position:n}),n=y(t,n+2);let a=V(t,n,$);if(!a)return{type:"error",position:n};if(r.push({name:"ident",position:n},{name:"ident_end",position:n+a}),n=y(t,n+a),t[n]!=="(")return{type:"error",position:n};n++,n=y(t,n)}else r.push({name:"ident",position:e},{name:"ident_end",position:n}),n=y(t,n+1);let i=n;if(t[n]!==")")for(;;){let a=g(t,n,0);if(a.type==="error")return a;if(r=r.concat(a.marks),i=a.position,n=y(t,a.position),t[n]!==","||(n=y(t,n+1),t[n]===")"))break}return t[n]!==")"?{type:"error",position:n}:(r.push({name:"func_args_end",position:i}),{type:"success",marks:r,position:n+1})}function Ae(t,e){let n=[{name:"object",position:e}];for(e=y(t,e+1);t[e]!=="}";){let r=e;if(t.slice(e,e+3)==="...")if(e=y(t,e+3),t[e]!=="}"&&t[e]!==","){let i=g(t,e,0);if(i.type==="error")return i;n.push({name:"object_splat",position:r}),n=n.concat(i.marks),e=i.position}else n.push({name:"object_splat_this",position:r});else{let i=g(t,e,0);if(i.type==="error")return i;let a=y(t,i.position);if(i.marks[0].name==="str"&&t[a]===":"){let o=g(t,y(t,a+1),0);if(o.type==="error")return o;n.push({name:"object_pair",position:r}),n=n.concat(i.marks,o.marks),e=o.position}else n=n.concat({name:"object_expr",position:e},i.marks),e=i.position}if(e=y(t,e),t[e]!==",")break;e=y(t,e+1)}return t[e]!=="}"?{type:"error",position:e}:(e++,n.push({name:"object_end",position:e}),{type:"success",marks:n,position:e})}function Vt(t,e){let n=t[e];e=e+1;let r=[{name:"str",position:e}];e:for(;;e++){if(e>t.length)return{type:"error",position:e};switch(t[e]){case n:{r.push({name:"str_end",position:e}),e++;break e}case"\\":r.push({name:"str_pause",position:e}),t[e+1]==="u"?t[e+2]==="{"?(r.push({name:"unicode_hex",position:e+3}),e=t.indexOf("}",e+3),r.push({name:"unicode_hex_end",position:e})):(r.push({name:"unicode_hex",position:e+2}),r.push({name:"unicode_hex_end",position:e+6}),e+=5):(r.push({name:"single_escape",position:e+1}),e+=1),r.push({name:"str_start",position:e+1})}}return{type:"success",marks:r,position:e}}function y(t,e){return e+V(t,e,It)}function V(t,e,n){let r=n.exec(t.slice(e));return r?r[0].length:0}function Ut(t,e,n){let r=n.exec(t.slice(e));return r?r[0]:null}function j(t,e){return n=>e(t(n))}function Oe(t){return e=>({type:"Map",base:e,expr:t({type:"This"})})}function Nt(t){return e=>({type:"FlatMap",base:e,expr:t({type:"This"})})}function ye(t,e){if(!e)return{type:"a-a",build:t};switch(e.type){case"a-a":return{type:"a-a",build:j(t,e.build)};case"a-b":return{type:"a-b",build:j(t,e.build)};case"b-b":return{type:"a-a",build:j(t,Oe(e.build))};case"b-a":return{type:"a-a",build:j(t,Nt(e.build))};default:throw new Error("unknown type: ".concat(e.type))}}function _e(t,e){if(!e)return{type:"b-b",build:t};switch(e.type){case"a-a":case"b-a":return{type:"b-a",build:j(t,e.build)};case"a-b":case"b-b":return{type:"b-b",build:j(t,e.build)};default:throw new Error("unknown type: ".concat(e.type))}}function qt(t,e){if(!e)return{type:"a-b",build:t};switch(e.type){case"a-a":case"b-a":return{type:"a-a",build:j(t,e.build)};case"a-b":case"b-b":return{type:"a-b",build:j(t,e.build)};default:throw new Error("unknown type: ".concat(e.type))}}function Bt(t,e){if(!e)return{type:"b-b",build:t};switch(e.type){case"a-a":return{type:"a-a",build:j(Oe(t),e.build)};case"a-b":return{type:"a-b",build:j(Oe(t),e.build)};case"b-a":return{type:"b-a",build:j(t,e.build)};case"b-b":return{type:"b-b",build:j(t,e.build)};default:throw new Error("unknown type: ".concat(e.type))}}var Ft={"'":"'",'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:`
`,r:"\r",t:"	"};function $t(t){let e=parseInt(t,16);return String.fromCharCode(e)}var O=class extends Error{constructor(){super(...arguments),this.name="GroqQueryError"}},h={group(t){return{type:"Group",base:t.process(h)}},everything(){return{type:"Everything"}},this(){return{type:"This"}},parent(){return{type:"Parent",n:1}},dblparent(t){return{type:"Parent",n:t.process(h).n+1}},traverse(t){let e=t.process(h),n=[];for(;t.getMark().name!=="traversal_end";)n.push(t.process(et));t.shift();let r=null;for(let i=n.length-1;i>=0;i--)r=n[i](r);if((e.type==="Everything"||e.type==="Array"||e.type==="PipeFuncCall")&&(r=ye(i=>i,r)),r===null)throw new Error("BUG: unexpected empty traversal");return r.build(e)},this_attr(t){let e=t.processString();return e==="null"?{type:"Value",value:null}:e==="true"?{type:"Value",value:!0}:e==="false"?{type:"Value",value:!1}:{type:"AccessAttribute",name:e}},neg(t){return{type:"Neg",base:t.process(h)}},pos(t){return{type:"Pos",base:t.process(h)}},add(t){let e=t.process(h),n=t.process(h);return{type:"OpCall",op:"+",left:e,right:n}},sub(t){let e=t.process(h),n=t.process(h);return{type:"OpCall",op:"-",left:e,right:n}},mul(t){let e=t.process(h),n=t.process(h);return{type:"OpCall",op:"*",left:e,right:n}},div(t){let e=t.process(h),n=t.process(h);return{type:"OpCall",op:"/",left:e,right:n}},mod(t){let e=t.process(h),n=t.process(h);return{type:"OpCall",op:"%",left:e,right:n}},pow(t){let e=t.process(h),n=t.process(h);return{type:"OpCall",op:"**",left:e,right:n}},comp(t){let e=t.process(h),n=t.processString(),r=t.process(h);return{type:"OpCall",op:n,left:e,right:r}},in_range(t){let e=t.process(h),n=t.getMark().name==="inc_range";t.shift();let r=t.process(h),i=t.process(h);return{type:"InRange",base:e,left:r,right:i,isInclusive:n}},str(t){let e="";e:for(;t.hasMark();){let n=t.getMark();switch(n.name){case"str_end":e+=t.processStringEnd();break e;case"str_pause":e+=t.processStringEnd();break;case"str_start":t.shift();break;case"single_escape":{let r=t.slice(1);t.shift(),e+=Ft[r];break}case"unicode_hex":t.shift(),e+=$t(t.processStringEnd());break;default:throw new Error("unexpected mark: ".concat(n.name))}}return{type:"Value",value:e}},integer(t){let e=t.processStringEnd();return{type:"Value",value:Number(e)}},float(t){let e=t.processStringEnd();return{type:"Value",value:Number(e)}},sci(t){let e=t.processStringEnd();return{type:"Value",value:Number(e)}},object(t){let e=[];for(;t.getMark().name!=="object_end";)e.push(t.process(Wt));return t.shift(),{type:"Object",attributes:e}},array(t){let e=[];for(;t.getMark().name!=="array_end";){let n=!1;t.getMark().name==="array_splat"&&(n=!0,t.shift());let r=t.process(h);e.push({type:"ArrayElement",value:r,isSplat:n})}return t.shift(),{type:"Array",elements:e}},tuple(t){let e=[];for(;t.getMark().name!=="tuple_end";)e.push(t.process(h));return t.shift(),{type:"Tuple",members:e}},func_call(t){let e="global";t.getMark().name==="namespace"&&(t.shift(),e=t.processString());let n=t.processString();if(e==="global"&&n==="select"){let o={type:"Select",alternatives:[]};for(;t.getMark().name!=="func_args_end";)if(t.getMark().name==="pair"){if(o.fallback)throw new O("unexpected argument to select()");t.shift();let c=t.process(h),f=t.process(h);o.alternatives.push({type:"SelectAlternative",condition:c,value:f})}else{if(o.fallback)throw new O("unexpected argument to select()");let c=t.process(h);o.fallback=c}return t.shift(),o}let r=[];for(;t.getMark().name!=="func_args_end";)Ht(e,n,r.length)?(t.process(Te),r.push({type:"Selector"})):r.push(t.process(h));if(t.shift(),e==="global"&&(n==="before"||n==="after")&&t.parseOptions.mode==="delta")return{type:"Context",key:n};if(e==="global"&&n==="boost"&&!t.allowBoost)throw new O("unexpected boost");let i=Rt[e];if(!i)throw new O("Undefined namespace: ".concat(e));let a=i[n];if(!a)throw new O("Undefined function: ".concat(n));if(a.arity!==void 0&&ze(n,a.arity,r.length),a.mode!==void 0&&a.mode!==t.parseOptions.mode)throw new O("Undefined function: ".concat(n));return{type:"FuncCall",func:a,name:n,args:r}},pipecall(t){let e=t.process(h);t.shift();let n="global";if(t.getMark().name==="namespace"&&(t.shift(),n=t.processString()),n!=="global")throw new O("Undefined namespace: ".concat(n));let r=t.processString(),i=[],a=t.allowBoost;for(r==="score"&&(t.allowBoost=!0);;){let c=t.getMark().name;if(c==="func_args_end")break;if(r==="order"){if(c==="asc"){t.shift(),i.push({type:"Asc",base:t.process(h)});continue}else if(c==="desc"){t.shift(),i.push({type:"Desc",base:t.process(h)});continue}}i.push(t.process(h))}t.shift(),t.allowBoost=a;let o=Y[r];if(!o)throw new O("Undefined pipe function: ".concat(r));return o.arity&&ze(r,o.arity,i.length),{type:"PipeFuncCall",func:o,base:e,name:r,args:i}},pair(t){throw new O("unexpected =>")},and(t){let e=t.process(h),n=t.process(h);return{type:"And",left:e,right:n}},or(t){let e=t.process(h),n=t.process(h);return{type:"Or",left:e,right:n}},not(t){return{type:"Not",base:t.process(h)}},asc(t){throw new O("unexpected asc")},desc(t){throw new O("unexpected desc")},param(t){let e=t.processString();return t.parseOptions.params&&t.parseOptions.params.hasOwnProperty(e)?{type:"Value",value:t.parseOptions.params[e]}:{type:"Parameter",name:e}}},Wt={object_expr(t){if(t.getMark().name==="pair"){t.shift();let n=t.process(h),r=t.process(h);return{type:"ObjectConditionalSplat",condition:n,value:r}}let e=t.process(h);return{type:"ObjectAttributeValue",name:tt(e),value:e}},object_pair(t){let e=t.process(h);if(e.type!=="Value")throw new Error("name must be string");let n=t.process(h);return{type:"ObjectAttributeValue",name:e.value,value:n}},object_splat(t){return{type:"ObjectSplat",value:t.process(h)}},object_splat_this(){return{type:"ObjectSplat",value:{type:"This"}}}},et={square_bracket(t){let e=t.process(h),n=ke(e);return n&&n.type==="number"?r=>qt(i=>({type:"AccessElement",base:i,index:n.data}),r):n&&n.type==="string"?r=>_e(i=>({type:"AccessAttribute",base:i,name:n.data}),r):r=>ye(i=>({type:"Filter",base:i,expr:e}),r)},slice(t){let e=t.getMark().name==="inc_range";t.shift();let n=t.process(h),r=t.process(h),i=ke(n),a=ke(r);if(!i||!a||i.type!=="number"||a.type!=="number")throw new O("slicing must use constant numbers");return o=>ye(c=>({type:"Slice",base:c,left:i.data,right:a.data,isInclusive:e}),o)},projection(t){let e=t.process(h);return n=>Bt(r=>({type:"Projection",base:r,expr:e}),n)},attr_access(t){let e=t.processString();return n=>_e(r=>({type:"AccessAttribute",base:r,name:e}),n)},deref(t){let e=null;t.getMark().name==="deref_attr"&&(t.shift(),e=t.processString());let n=r=>e?{type:"AccessAttribute",base:r,name:e}:r;return r=>_e(i=>n({type:"Deref",base:i}),r)},array_postfix(t){return e=>ye(n=>({type:"ArrayCoerce",base:n}),e)}},Te={group(t){return t.process(Te),null},everything(){throw new Error("Invalid selector syntax")},this(){throw new Error("Invalid selector syntax")},parent(){throw new Error("Invalid selector syntax")},dblparent(t){throw new Error("Invalid selector syntax")},traverse(t){for(t.process(Te);t.getMark().name!=="traversal_end";)t.process(et);return t.shift(),null},this_attr(t){return t.processString(),null},neg(t){throw new Error("Invalid selector syntax")},pos(t){throw new Error("Invalid selector syntax")},add(t){throw new Error("Invalid selector syntax")},sub(t){throw new Error("Invalid selector syntax")},mul(t){throw new Error("Invalid selector syntax")},div(t){throw new Error("Invalid selector syntax")},mod(t){throw new Error("Invalid selector syntax")},pow(t){throw new Error("Invalid selector syntax")},comp(t){throw new Error("Invalid selector syntax")},in_range(t){throw new Error("Invalid selector syntax")},str(t){throw new Error("Invalid selector syntax")},integer(t){throw new Error("Invalid selector syntax")},float(t){throw new Error("Invalid selector syntax")},sci(t){throw new Error("Invalid selector syntax")},object(t){throw new Error("Invalid selector syntax")},array(t){throw new Error("Invalid selector syntax")},tuple(t){throw new Error("Invalid selector syntax")},func_call(t,e){let n=h.func_call(t,e);if(n.name==="anywhere"&&n.args.length===1)return null;throw new Error("Invalid selector syntax")},pipecall(t){throw new Error("Invalid selector syntax")},pair(t){throw new Error("Invalid selector syntax")},and(t){throw new Error("Invalid selector syntax")},or(t){throw new Error("Invalid selector syntax")},not(t){throw new Error("Invalid selector syntax")},asc(t){throw new Error("Invalid selector syntax")},desc(t){throw new Error("Invalid selector syntax")},param(t){throw new Error("Invalid selector syntax")}};function tt(t){if(t.type==="AccessAttribute"&&!t.base)return t.name;if(t.type==="Deref"||t.type==="Map"||t.type==="Projection"||t.type==="Slice"||t.type==="Filter"||t.type==="AccessElement"||t.type==="ArrayCoerce")return tt(t.base);throw new O("Cannot determine property key for type: ".concat(t.type))}function ze(t,e,n){if(typeof e=="number"){if(n!==e)throw new O("Incorrect number of arguments to function ".concat(t,"(). Expected ").concat(e,", got ").concat(n,"."))}else if(e&&!e(n))throw new O("Incorrect number of arguments to function ".concat(t,"()."))}function Ht(t,e,n){let r=["changedAny","changedOnly"];return t=="diff"&&n==2&&r.includes(e)}var Ce=class extends Error{constructor(e){super("Syntax error in GROQ query at position ".concat(e)),this.name="GroqSyntaxError",this.position=e}};function Me(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=Lt(t);if(n.type==="error")throw new Ce(n.position);return new Se(t,n.marks,e).process(h)}var nt;function Gt(t,e){return e||(e=t.slice(0)),Object.freeze(Object.defineProperties(t,{raw:{value:Object.freeze(e)}}))}var zt=t=>typeof window<"u"&&t.addEventListener===window.EventSource.prototype.addEventListener,we=(t,e,n)=>{zt(t)&&t.addEventListener(e,n,!1),t.addEventListener(e,n)};function Jt(t,e,n){let{projectId:r,dataset:i,token:a}=e,o=a?{Authorization:"Bearer ".concat(a)}:void 0,c="https://".concat(r,".api.sanity.io/v1/data/listen/").concat(i,"?query=*&effectFormat=mendoza"),f=new t(c,{withCredentials:!0,headers:o});return we(f,"welcome",n.open),we(f,"mutation",Qt(n.next)),we(f,"channelError",s=>{f.close();let d;try{d=JSON.parse(s.data)}catch{n.error(new Error("Unknown error parsing listener message"));return}n.error(new Error(d.message||d.error||"Listener returned HTTP ".concat(d.statusCode)))}),we(f,"error",s=>{let d=typeof window<"u"&&window.location.origin,u=d?", and that the CORS-origin (".concat(d,") is allowed"):"",p=Zt(s)?" (".concat(s.message,")"):"";n.error(new Error("Error establishing listener - check that the project ID and dataset are correct".concat(u).concat(p)))}),{unsubscribe:()=>Promise.resolve(f.close())}}function Qt(t){return e=>{let n;try{n=JSON.parse(e.data)}catch{return}t(n)}}function Zt(t){return typeof t=="object"&&t!==null&&"message"in t}function Xt(t){return t._id.startsWith("drafts.")}function De(t){return Xt(t)?t._id.slice(7):t._id}function it(t,e){let n={...t};return delete n._rev,Ve(n,e)}var Yt=25;function rt(){return Promise.resolve()}function Kt(t,e,n){let{getDocuments:r,EventSource:i}=n,{projectId:a,dataset:o,listen:c,overlayDrafts:f,documentLimit:s,token:d,includeTypes:u}=t;if(!c){let b=r({projectId:a,dataset:o,documentLimit:s,token:d,includeTypes:u}).then(te).then(rt);return{unsubscribe:rt,loaded:b}}let p=new Map,w,m=[],k,E,P=new Promise((b,T)=>{k=b,E=T}),C,L,z;return{unsubscribe:Jt(i,t,{next:ot,open:ee,error:b=>E(b)}).unsubscribe,loaded:P};async function ee(){let b=await r({projectId:a,dataset:o,documentLimit:s,token:d,includeTypes:u});w=en(b,m),w.forEach(T=>p.set(T._id,T)),te(w),k()}function ot(b){w?(ct(b),st(w,b)):m.push(b)}function st(b,T){clearTimeout(z),L!==T.transactionId&&C?(te(C),L=void 0):(L=T.transactionId,C=b.slice()),z=setTimeout(te,Yt,b.slice())}function te(b){C=void 0,z=void 0,L=void 0,e(f?tn(b):b)}function ct(b){if(!b.effects||b.documentId.startsWith("_."))return;let T=p.get(b.documentId)||null;ut(b.documentId,it(T,b.effects.apply))}function ut(b,T){let Le=p.get(b),ne=w||[],be=Le?ne.indexOf(Le):-1;be===-1&&T?(ne.push(T),p.set(b,T)):T?(ne.splice(be,1,T),p.set(b,T)):(ne.splice(be,1),p.delete(b))}}function en(t,e){let n=new Map;return e.forEach(r=>{let i=n.get(r.documentId)||[];i.push(r),n.set(r.documentId,i)}),n.forEach((r,i)=>{let a=t.find(f=>f._id===i);if(!a){console.warn("Received mutation for missing document %s",i);return}let o=!1,c=a;r.forEach(f=>{o=o||f.previousRev===a._rev,!!o&&f.effects&&(c=it(c,f.effects.apply))}),t.splice(t.indexOf(a),1,c)}),t}function tn(t){let e=new Map;return t.forEach(n=>{let r=e.get(De(n));n._id.startsWith("drafts.")?e.set(De(n),nn(n)):r||e.set(n._id,n)}),Array.from(e.values())}function nn(t){return{...t,_id:De(t)}}function rn(t,e){let n=[],r=qe(t.subscriptionThrottleMs||50,p),i=[],a;async function o(){a||(a=Kt(t,m=>{n=m,r()},e)),await a.loaded}async function c(m,k){await o();let E=Me(m,{params:k});return(await Re(E,{dataset:n,params:k})).get()}async function f(m){return await o(),c(ge(nt||(nt=Gt(["*[_id == $id][0]"]))),{id:m})}async function s(m){await o();let k=m.map(E=>'*[_id == "'.concat(E,'"][0]')).join(`,
`);return c("[".concat(k,"]"))}function d(m,k,E){if(!t.listen)throw new Error("Cannot use `subscribe()` without `listen: true`");let P={query:m,params:k,callback:E};i.push(P);let C=!1,L=()=>(C||(C=!0,i.splice(i.indexOf(P),1)),Promise.resolve());return u(P),{unsubscribe:L}}function u(m){return c(m.query,m.params).then(k=>{"previousResult"in m&&(0,at.default)(m.previousResult,k)||(m.previousResult=k,m.callback(void 0,k))}).catch(k=>{m.callback(k)})}function p(){i.forEach(u)}function w(){return r.cancel(),a?a.unsubscribe():Promise.resolve()}return{query:c,getDocument:f,getDocuments:s,subscribe:d,close:w}}var an=async function(e){let{projectId:n,dataset:r,token:i,documentLimit:a,includeTypes:o=[]}=e,c="https://".concat(n,".api.sanity.io/v1/data/export/").concat(r),f=o.length>0?new URLSearchParams({types:o?.join(",")}):"",s="".concat(c,"?").concat(f),d=i?{Authorization:"Bearer ".concat(i)}:void 0,u=await fetch(s,{credentials:"include",headers:d});if(u.status!==200)throw new Error("Error streaming dataset: ".concat(cn(await u.json())));let w=on(u.body).getReader(),m=[],k,E;do{if(k=await w.read(),E=k.value,sn(E))throw new Error("Error streaming dataset: ".concat(E.error));if(E&&un(E)&&m.push(E),a&&m.length>a)throw w.cancel("Reached document limit"),new Error("Error streaming dataset: Reached limit of ".concat(a," documents. Try using the includeTypes option to reduce the amount of documents, or increase the limit."))}while(!k.done);return m};function on(t){if(!t)throw new Error("Failed to read body from response");let e,n=!1;function r(){n=!0,e&&e.cancel()}return new ReadableStream({start(i){e=t.getReader();let a=new TextDecoder,o="";e.read().then(c).catch(f=>i.error(f));async function c(f){if(f.done){if(n)return;if(o=o.trim(),o.length===0){i.close();return}i.enqueue(JSON.parse(o)),i.close();return}o+=a.decode(f.value,{stream:!0});let s=o.split(`
`);for(let d=0;d<s.length-1;++d){let u=s[d].trim();if(u.length!==0)try{i.enqueue(JSON.parse(u))}catch(p){i.error(p),r();return}}if(o=s[s.length-1],!!e)try{c(await e.read())}catch(d){i.error(d)}}},cancel:r})}function sn(t){return!t||!("error"in t)||typeof t.error!="object"||t.error===null?!1:"description"in t.error&&typeof t.error.description=="string"&&!("_id"in t)}function cn(t){return typeof t=="object"&&"error"in t&&"message"in t?t.message||t.error:"<unknown error>"}function un(t){return!t._id.startsWith("_.")}function ln(){let e=["EventSource","ReadableStream","fetch"].filter(n=>!(n in window));if(e.length>0)throw new Error("Browser not supported. Missing browser APIs: ".concat(e.join(", ")))}function kn(t){var e;ln();let n=(e=t.EventSource)!=null?e:window.EventSource;if(t.token){if(!t.EventSource)throw new Error("When the `token` option is used the `EventSource` option must also be provided.");if(t.EventSource===window.EventSource)throw new Error("When the `token` option is used the `EventSource` option must also be provided. EventSource cannot be `window.EventSource`, as it does not support passing a token.")}return rn(t,{EventSource:n,getDocuments:an})}export{ge as groq,kn as groqStore};
